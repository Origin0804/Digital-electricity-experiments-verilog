# Lab7 上板使用指南

## 上板前准备

### 1. 确认引脚分配

**重要：** 在综合前必须确认以下引脚分配：

#### J5扩展口信号输入引脚
- 当前约束文件使用 **M2** 作为示例引脚
- **必须根据实际硬件连接修改** `lab7.xdc` 文件中的 `signal_in` 引脚
- 查阅EGO1用户手册，找到J5扩展口的IO_L18N引脚编号
- 修改约束文件第33行的引脚定义

#### DAC0832引脚
- 当前使用DIP开关引脚（T5, T3, R3, V4, V5, V2, U2, U3）作为DAC数据线
- 如果您的硬件有专用DAC接口，需要修改约束文件第52-59行
- 同时修改DAC控制信号引脚（WR1, WR2, CS）在第62-64行

### 2. 硬件连接检查清单

- [ ] NE555输出经100Ω限流电阻连接到FPGA输入
- [ ] DAC0832模块正确连接到FPGA引脚
- [ ] DAC输出连接到NE555的第5脚（控制电压端）
- [ ] 所有地线共地
- [ ] 电源电压正确（3.3V或5V，根据模块要求）

## Vivado工程创建步骤

### 1. 创建新工程
```tcl
# 在Vivado中创建新工程
# File -> New Project
# 选择目标器件：XC7A35T-CPG236（或您的EGO1板实际器件）
```

### 2. 添加源文件
```tcl
# 添加以下源文件（按顺序）：
src/clk_div.v
src/freq_meter.v
src/dac_ctrl.v
src/display_driver.v
src/top.v

# 设置 top.v 为顶层模块
```

### 3. 添加约束文件
```tcl
# 添加约束文件
lab7.xdc

# 修改前请确认引脚分配正确！
```

### 4. 综合与实现
```tcl
# 运行综合 (Run Synthesis)
# 检查综合报告，确认无严重警告
# 
# 运行实现 (Run Implementation)
# 检查时序报告，确认时序收敛
# 
# 生成比特流 (Generate Bitstream)
```

## 上板验证步骤

### 第一步：基本功能测试

1. **下载比特流到FPGA**
   - 连接JTAG线
   - Open Hardware Manager
   - Program Device

2. **观察初始状态**
   - 数码管应显示 "0000"（无输入信号时）
   - LED0应该闪烁（1Hz测量窗口指示）
   - LED1应该暗（无输入信号）

3. **测试信号输入**
   - 使用信号发生器产生1kHz方波
   - 连接到信号输入引脚
   - 数码管应显示约 "1000"
   - LED1应该闪烁（信号指示）

### 第二步：频率测量验证

使用信号发生器测试不同频率：

| 输入频率 | 预期显示 | 误差范围 |
|---------|---------|---------|
| 100 Hz  | 0100    | ±1 Hz   |
| 500 Hz  | 0500    | ±1 Hz   |
| 1000 Hz | 1000    | ±1 Hz   |
| 2000 Hz | 2000    | ±1 Hz   |
| 5000 Hz | 5000    | ±2 Hz   |

### 第三步：DAC控制测试

1. **连接NE555电路**
   - 确保NE555电路工作正常
   - DAC输出连接到NE555第5脚

2. **调节拨码开关**
   - 从 00000000 逐渐调到 11111111
   - 观察数码管显示的频率变化
   - 频率应随DAC输出电压变化

3. **记录控制曲线**
   - 记录不同拨码开关设置下的频率值
   - 绘制DAC输入-频率输出曲线

## 常见问题排查

### 问题1：数码管不显示

**可能原因：**
- 约束文件引脚分配错误
- 数码管极性设置错误
- 扫描频率过高或过低

**排查步骤：**
1. 检查约束文件中数码管引脚是否正确
2. 确认数码管为共阴极，位选和段选均为高有效
3. 使用ILA（Integrated Logic Analyzer）观察内部信号

### 问题2：频率测量不准确

**可能原因：**
- 系统时钟频率不是100MHz
- 输入信号质量差（有噪声）
- 信号输入未两级同步

**排查步骤：**
1. 确认时钟约束为100MHz
2. 检查输入信号波形是否干净
3. 增加限流电阻值（100Ω可能不够）
4. 使用示波器观察输入信号

### 问题3：DAC控制无效

**可能原因：**
- DAC接线错误
- WR1/WR2/CS信号极性错误
- DAC电源未连接

**排查步骤：**
1. 用万用表测量DAC输出电压
2. 检查WR1/WR2/CS信号极性（低有效）
3. 确认DAC供电正常
4. 查阅DAC0832数据手册确认接线

### 问题4：显示数字乱跳

**可能原因：**
- 输入信号频率变化太快
- 测量窗口过短
- 输入信号有干扰

**排查步骤：**
1. 使用示波器观察输入信号稳定性
2. 增加滤波电容
3. 改善接地

## 性能优化建议

### 提高测量精度
- 使用更长的测量窗口（2秒或更长）
- 增加频率计数器位宽
- 添加数字滤波（移动平均）

### 提高响应速度
- 使用更短的测量窗口（0.1秒）
- 但会降低低频测量精度

### 增强抗干扰能力
- 在输入端加RC滤波器
- 使用施密特触发器整形
- 增加输入保护电路

## 安全注意事项

1. **防止过流损坏**
   - 必须使用限流电阻（建议200Ω~1kΩ）
   - 不要直接连接高电平信号

2. **防止静电损坏**
   - 操作前触摸接地金属释放静电
   - 使用防静电手环

3. **防止短路**
   - 仔细检查接线
   - 先断电再接线
   - 使用万用表确认连接

4. **电压兼容**
   - 确认所有信号电压≤3.3V
   - DAC输出电压应在NE555允许范围内

## 进阶实验

完成基本实验后，可以尝试：

1. **实现闭环控制**
   - 添加目标频率设置
   - 实现PID控制算法
   - 自动调节DAC输出

2. **增加功能**
   - 添加最大/最小频率记录
   - 显示频率稳定度
   - 添加报警功能

3. **性能提升**
   - 使用等精度测频法
   - 增加频率范围
   - 提高测量精度

## 实验报告建议

### 必须包含的内容

1. **实验目的和原理**
   - 测频法原理说明
   - DAC控制原理

2. **系统框图**
   - 硬件连接框图
   - FPGA内部模块框图

3. **关键代码分析**
   - 频率测量模块
   - 显示驱动模块
   - DAC控制模块

4. **测试结果**
   - 频率测量精度测试数据
   - DAC控制曲线
   - 照片或截图

5. **问题与解决**
   - 遇到的问题
   - 解决方法

6. **总结与体会**
   - 实验收获
   - 改进建议

## 参考资料

1. EGO1 FPGA开发板用户手册
2. NE555定时器数据手册
3. DAC0832数模转换器数据手册
4. Verilog HDL数字设计教程
5. Vivado设计套件用户指南

---

**祝实验顺利！**

如有问题，请参考README.md或查阅相关数据手册。
