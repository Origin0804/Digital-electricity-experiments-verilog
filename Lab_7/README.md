# Lab7 - 频率测量与控制系统

## 实验概述

本实验实现了一个数模混合系统，用于测量NE555多谐振荡器的输出频率，并通过DAC0832控制其振荡频率。

### 功能特性

1. **频率测量**：使用测频法测量输入方波信号的频率（0~9999 Hz）
2. **频率显示**：在4位数码管上实时显示测得的频率值
3. **频率控制**：通过8位拨码开关控制DAC0832输出电压，改变NE555振荡频率

## 硬件连接

### NE555信号输入
- NE555的输出信号（第3脚）经过**100Ω限流电阻**后，连接到EGO1板卡的J5扩展口
- FPGA引脚：M2（需根据实际硬件确认）

### DAC0832连接
- 8位数据线（DI7~DI0）：连接到FPGA的DIP开关引脚或其他可用引脚
- 控制信号：
  - WR1（写使能1）：引脚 M3
  - WR2（写使能2）：引脚 L6
  - CS（片选）：引脚 N1
- DAC输出（VOUT）：连接到NE555的第5脚（控制电压端）

### 拨码开关
- SW0~SW7：控制DAC输出电压的8位数字量
- 拨到上方为高电平（1），拨到下方为低电平（0）

### 数码管显示
- 使用右侧4位数码管（AN0~AN3）
- 显示格式：千位-百位-十位-个位
- 显示范围：0000~9999 Hz

### LED指示
- LED0：测量窗口tick指示（1Hz闪烁）
- LED1：输入信号指示
- LED2：频率 > 1kHz 指示
- LED3：频率 > 5kHz 指示

## 模块说明

### 1. clk_div.v - 时钟分频模块
生成系统所需的各种时钟信号：
- `clk_1Hz`：1Hz测量窗口tick，用于频率测量
- `clk_scan`：1kHz数码管扫描时钟
- `clk_db`：100Hz消抖时钟

### 2. freq_meter.v - 频率测量模块
- 测量原理：测频法
- 测量窗口：1秒
- 测量范围：0~65535 Hz（显示限制为0~9999 Hz）
- 输入信号：经过两级同步以防止亚稳态
- 边沿检测：检测上升沿并计数

### 3. dac_ctrl.v - DAC控制模块
- 工作模式：直通模式
- 控制方式：WR1和WR2同时有效
- 输入：8位拨码开关值
- 输出：DAC数据和控制信号

### 4. display_driver.v - 显示驱动模块
- 显示位数：4位
- 扫描频率：1kHz
- 显示格式：十进制（0000~9999）
- 数码管类型：共阴极，段选和位选均为高有效

### 5. top.v - 顶层模块
集成所有子模块，完成系统级功能

## 使用方法

### 1. 硬件准备
1. 在面包板上搭建NE555多谐振荡器电路
2. 将NE555输出（第3脚）经100Ω电阻连接到FPGA的J5扩展口
3. 连接DAC0832模块到FPGA
4. 将DAC输出连接到NE555的第5脚（控制电压）

### 2. 程序下载
1. 使用Vivado打开工程
2. 添加所有源文件（`src/`目录下的所有.v文件）
3. 添加约束文件（`lab7.xdc`）
4. 综合、实现、生成比特流
5. 下载到EGO1开发板

### 3. 实验操作
1. 上电后，复位按键（S6）复位系统
2. 观察数码管显示的频率值
3. 调节8位拨码开关，改变DAC输出电压
4. 观察频率值的变化
5. LED指示灯显示系统状态

## 测试与验证

### 测量精度验证
1. 使用信号发生器产生已知频率的方波信号
2. 将信号接入FPGA输入端
3. 观察数码管显示的频率值是否与实际频率一致
4. 误差应在±1 Hz以内

### 控制功能验证
1. 连接NE555电路
2. 调节拨码开关从00000000到11111111
3. 观察频率值的变化趋势
4. 验证频率随DAC输出电压的变化关系

## 注意事项

1. **限流保护**：NE555输出必须经过100Ω电阻后再连接FPGA，防止过流损坏
2. **引脚确认**：使用前请根据实际硬件确认J5扩展口的具体引脚（本设计使用M2作为示例）
3. **DAC连接**：DAC数据线和控制信号的引脚需要根据实际硬件连接调整约束文件
4. **电压兼容**：确保DAC输出电压与NE555工作电压兼容
5. **复位极性**：复位按键S6按下为高电平，释放为低电平

## 可能的改进

### 升级任务：闭环自适应控制
可以在现有基础上添加以下功能：
1. 添加目标频率设置模块（通过按键或拨码开关）
2. 实现PID控制算法
3. 根据测量频率与目标频率的差值，自动调节DAC输出
4. 实现频率锁定功能

### 其他改进方向
1. 增加测量精度：使用更短的测量窗口配合倍频计算
2. 添加频率范围自动切换
3. 增加历史频率曲线显示（需要额外的显示设备）
4. 添加串口通信，上传数据到上位机

## 故障排查

### 数码管不显示或显示异常
1. 检查约束文件中的引脚分配是否正确
2. 确认数码管的共阴/共阳类型
3. 检查位选和段选信号的极性

### 频率测量不准确
1. 检查输入信号是否正常
2. 确认时钟频率为100MHz
3. 检查两级同步电路是否工作正常

### DAC控制无效
1. 检查DAC连接是否正确
2. 确认WR1、WR2、CS信号的极性
3. 使用万用表测量DAC输出电压

## 文件清单

```
Lab_7/
├── src/
│   ├── top.v                 # 顶层模块
│   ├── clk_div.v            # 时钟分频模块
│   ├── freq_meter.v         # 频率测量模块
│   ├── dac_ctrl.v           # DAC控制模块
│   ├── display_driver.v     # 显示驱动模块
│   └── debounce.v           # 按键消抖模块（预留）
├── lab7.xdc                 # 约束文件
├── request.md               # 实验要求
└── README.md                # 本文件
```

## 参考资料

1. EGO1用户手册
2. NE555数据手册
3. DAC0832数据手册
4. Verilog HDL数字设计教程
